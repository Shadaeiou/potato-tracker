<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ü•î Potato Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class'
    }
  </script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    const useDarkMode = () => {
      const [isDark, setIsDark] = useState(() => {
        const saved = localStorage.getItem('darkMode');
        return saved ? JSON.parse(saved) : false;
      });
      
      useEffect(() => {
        localStorage.setItem('darkMode', JSON.stringify(isDark));
        if (isDark) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      }, [isDark]);
      
      return [isDark, setIsDark];
    };
    
    const Calculator = () => <span>üßÆ</span>;
    const Clock = () => <span>‚è∞</span>;
    const Utensils = () => <span>üçΩÔ∏è</span>;
    const TrendingUp = () => <span>üìà</span>;
    const Calendar = () => <span>üìÖ</span>;

    const WeightView = ({ sortedWeights, latestWeight, oldestWeight, weightChange, chartData, pathD, getX, getY, chartWidth, chartHeight, padding, weights, setWeights, settings, setSettings, calcBMR, setView }) => {
      const [editingWeight, setEditingWeight] = useState(null);
      const [editWeightVal, setEditWeightVal] = useState('');
      
      const startEditWeight = (date, weight) => {
        setEditingWeight(date);
        setEditWeightVal(weight.toString());
      };
      
      const saveWeightEdit = (date) => {
        if (editWeightVal && settings) {
          const newWeights = {...weights};
          newWeights[date] = parseFloat(editWeightVal);
          setWeights(newWeights);
          localStorage.setItem('pw', JSON.stringify(newWeights));
          
          const mostRecentDate = sortedWeights[0][0];
          if (date === mostRecentDate) {
            const newBmr = calcBMR(editWeightVal, settings.heightFt, settings.heightIn, settings.age, settings.gender);
            const deficit = settings.bmr - settings.goal;
            const updatedSettings = {
              ...settings,
              currentWeight: parseFloat(editWeightVal),
              bmr: newBmr,
              goal: newBmr - deficit
            };
            setSettings(updatedSettings);
            localStorage.setItem('ps', JSON.stringify(updatedSettings));
          }
          
          setEditingWeight(null);
        }
      };
      
      const deleteWeight = (date) => {
        const newWeights = {...weights};
        delete newWeights[date];
        setWeights(newWeights);
        localStorage.setItem('pw', JSON.stringify(newWeights));
        setEditingWeight(null);
      };
      
      return (
        <div className="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 dark:from-gray-900 dark:to-gray-800 p-6">
          <div className="max-w-4xl mx-auto bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8">
            <div className="flex justify-between items-center mb-6">
              <h1 className="text-3xl font-bold text-gray-800 dark:text-white">‚öñÔ∏è Weight Progress</h1>
              <button onClick={() => setView('main')} className="px-4 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white rounded-lg">Back</button>
            </div>
            
            {sortedWeights.length > 0 ? (
              <>
                <div className="grid grid-cols-3 gap-4 mb-6">
                  <div className="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                    <p className="text-sm text-gray-600 dark:text-gray-400 mb-1">Current Weight</p>
                    <p className="text-3xl font-bold text-blue-700 dark:text-blue-400">{latestWeight} lbs</p>
                  </div>
                  <div className="bg-purple-50 dark:bg-purple-900/30 border border-purple-200 dark:border-purple-800 rounded-lg p-4">
                    <p className="text-sm text-gray-600 dark:text-gray-400 mb-1">Starting Weight</p>
                    <p className="text-3xl font-bold text-purple-700 dark:text-purple-400">{oldestWeight} lbs</p>
                  </div>
                  {weightChange && (
                    <div className={`border rounded-lg p-4 ${parseFloat(weightChange) <= 0 ? 'bg-green-50 dark:bg-green-900/30 border-green-200 dark:border-green-800' : 'bg-orange-50 dark:bg-orange-900/30 border-orange-200 dark:border-orange-800'}`}>
                      <p className="text-sm text-gray-600 dark:text-gray-400 mb-1">Total Change</p>
                      <p className={`text-3xl font-bold ${parseFloat(weightChange) <= 0 ? 'text-green-700 dark:text-green-400' : 'text-orange-700 dark:text-orange-400'}`}>
                        {parseFloat(weightChange) > 0 ? '+' : ''}{weightChange} lbs
                      </p>
                    </div>
                  )}
                </div>
                
                {chartData.length > 1 && (
                  <div className="bg-gradient-to-br from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-lg p-6 mb-6">
                    <h3 className="text-lg font-semibold mb-4 dark:text-white">Weight Trend</h3>
                    <div className="flex justify-center">
                      <svg viewBox={`0 0 ${chartWidth} ${chartHeight}`} className="w-full max-w-2xl">
                        {[0, 1, 2, 3, 4].map(i => {
                          const y = padding + (i / 4) * (chartHeight - 2 * padding);
                          const maxW = chartData.length > 0 ? Math.max(...chartData.map(([, w]) => w)) : 0;
                          const minW = chartData.length > 0 ? Math.min(...chartData.map(([, w]) => w)) : 0;
                          const range = maxW - minW || 10;
                          const weight = (maxW + range * 0.1) - (i / 4) * (range * 1.2);
                          return (
                            <g key={i}>
                              <line x1={padding} y1={y} x2={chartWidth - padding} y2={y} stroke="#e5e7eb" strokeWidth="1" />
                              <text x={padding - 5} y={y + 5} textAnchor="end" fontSize="12" fill="#6b7280">{weight.toFixed(1)}</text>
                            </g>
                          );
                        })}
                        
                        <path d={pathD} fill="none" stroke="#3b82f6" strokeWidth="3" />
                        
                        {chartData.map(([date, weight], i) => (
                          <g key={date}>
                            <circle cx={getX(i)} cy={getY(weight)} r="5" fill="#3b82f6" stroke="white" strokeWidth="2" />
                            <text x={getX(i)} y={chartHeight - 10} textAnchor="middle" fontSize="10" fill="#6b7280">
                              {new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                            </text>
                          </g>
                        ))}
                      </svg>
                    </div>
                  </div>
                )}
                
                <div className="space-y-3">
                  <h3 className="text-lg font-semibold dark:text-white">Weight History</h3>
                  {sortedWeights.map(([date, weight]) => (
                    <div key={date} className="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                      {editingWeight === date ? (
                        <div className="flex gap-2 items-center">
                          <span className="font-medium dark:text-white">{new Date(date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</span>
                          <input 
                            type="number" 
                            step="0.1" 
                            value={editWeightVal} 
                            onChange={(e) => setEditWeightVal(e.target.value)} 
                            className="w-24 px-2 py-1 border dark:border-gray-600 dark:bg-gray-600 dark:text-white rounded" 
                          />
                          <span className="text-sm dark:text-gray-300">lbs</span>
                          <button onClick={() => saveWeightEdit(date)} className="text-green-600 dark:text-green-400 font-medium text-sm">Save</button>
                          <button onClick={() => setEditingWeight(null)} className="text-gray-600 dark:text-gray-400 font-medium text-sm">Cancel</button>
                          <button onClick={() => deleteWeight(date)} className="text-red-600 dark:text-red-400 font-medium text-sm ml-auto">Delete</button>
                        </div>
                      ) : (
                        <div className="flex justify-between items-center">
                          <span className="font-medium dark:text-white">{new Date(date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</span>
                          <div className="flex items-center gap-3">
                            <span className="text-lg font-bold text-gray-800 dark:text-gray-200">{weight} lbs</span>
                            <div className="flex gap-2">
                              <button onClick={() => startEditWeight(date, weight)} className="text-blue-600 dark:text-blue-400 text-sm font-medium">Edit</button>
                              <button onClick={() => deleteWeight(date)} className="text-red-600 dark:text-red-400 text-sm font-medium">Delete</button>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </>
            ) : (
              <p className="text-center py-12 text-gray-500 dark:text-gray-400">No weight entries yet. Start tracking on Mondays!</p>
            )}
          </div>
        </div>
      );
    };

    const DayDetailModal = ({ selectedDay, dayData, date, netCal, history, setHistory, settings, setSelectedDay }) => {
      const [editingDay, setEditingDay] = useState(false);
      const [editDayVals, setEditDayVals] = useState({ tot: '', exTotal: '' });
      
      const startEditDay = () => {
        setEditingDay(true);
        setEditDayVals({ tot: dayData.tot.toString(), exTotal: (dayData.exTotal || 0).toString() });
      };
      
      const saveDayEdit = () => {
        const tot = parseInt(editDayVals.tot);
        const exTotal = parseInt(editDayVals.exTotal);
        const netCals = tot - exTotal;
        const newHistory = {...history};
        newHistory[selectedDay] = {
          ...newHistory[selectedDay],
          tot,
          exTotal,
          ok: netCals <= (newHistory[selectedDay].bmr || settings.bmr)
        };
        setHistory(newHistory);
        localStorage.setItem('ph', JSON.stringify(newHistory));
        setEditingDay(false);
      };
      
      const deleteDayEntry = () => {
        if (confirm('Delete this day from history?')) {
          const newHistory = {...history};
          delete newHistory[selectedDay];
          setHistory(newHistory);
          localStorage.setItem('ph', JSON.stringify(newHistory));
          setSelectedDay(null);
        }
      };
      
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div className="sticky top-0 bg-white dark:bg-gray-800 border-b dark:border-gray-700 p-6 flex justify-between items-center">
              <div>
                <h2 className="text-2xl font-bold dark:text-white">{date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}</h2>
                <span className={`inline-block mt-2 px-3 py-1 rounded-full text-sm font-medium ${dayData.ok ? 'bg-green-200 dark:bg-green-900/50 text-green-800 dark:text-green-300' : 'bg-red-200 dark:bg-red-900/50 text-red-800 dark:text-red-300'}`}>
                  {dayData.ok ? '‚úì Success' : '‚úó Failed'}
                </span>
              </div>
              <button onClick={() => setSelectedDay(null)} className="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 text-2xl">&times;</button>
            </div>
            
            <div className="p-6 space-y-6">
              {editingDay ? (
                <div className="space-y-4">
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium mb-1 dark:text-gray-300">Food Consumed</label>
                      <input 
                        type="number" 
                        min="0" 
                        value={editDayVals.tot} 
                        onChange={(e) => setEditDayVals({...editDayVals, tot: e.target.value})} 
                        className="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg" 
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1 dark:text-gray-300">Exercise Burned</label>
                      <input 
                        type="number" 
                        min="0" 
                        value={editDayVals.exTotal} 
                        onChange={(e) => setEditDayVals({...editDayVals, exTotal: e.target.value})} 
                        className="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg" 
                      />
                    </div>
                  </div>
                  <div className="flex gap-2">
                    <button onClick={saveDayEdit} className="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium">Save</button>
                    <button onClick={() => setEditingDay(false)} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white rounded-lg font-medium">Cancel</button>
                  </div>
                </div>
              ) : (
                <>
                  <div className="grid grid-cols-2 gap-4">
                    <div className="bg-orange-50 dark:bg-orange-900/30 border border-orange-200 dark:border-orange-800 rounded-lg p-4">
                      <p className="text-sm text-gray-600 dark:text-gray-400 mb-1">Food Consumed</p>
                      <p className="text-3xl font-bold text-orange-700 dark:text-orange-400">{dayData.tot}</p>
                      <p className="text-xs text-gray-500 dark:text-gray-500 mt-1">calories</p>
                    </div>
                    <div className="bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 rounded-lg p-4">
                      <p className="text-sm text-gray-600 dark:text-gray-400 mb-1">Exercise Burned</p>
                      <p className="text-3xl font-bold text-green-700 dark:text-green-400">{dayData.exTotal || 0}</p>
                      <p className="text-xs text-gray-500 dark:text-gray-500 mt-1">calories</p>
                    </div>
                    <div className="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                      <p className="text-sm text-gray-600 dark:text-gray-400 mb-1">Net Calories</p>
                      <p className="text-3xl font-bold text-blue-700 dark:text-blue-400">{netCal}</p>
                      <p className="text-xs text-gray-500 dark:text-gray-500 mt-1">food - exercise</p>
                    </div>
                    <div className="bg-purple-50 dark:bg-purple-900/30 border border-purple-200 dark:border-purple-800 rounded-lg p-4">
                      <p className="text-sm text-gray-600 dark:text-gray-400 mb-1">Daily Goal</p>
                      <p className="text-3xl font-bold text-purple-700 dark:text-purple-400">{dayData.goal}</p>
                      <p className="text-xs text-gray-500 dark:text-gray-500 mt-1">target</p>
                    </div>
                  </div>
                  
                  <div className={`border-2 rounded-lg p-4 ${dayData.ok ? 'bg-green-50 dark:bg-green-900/30 border-green-200 dark:border-green-800' : 'bg-red-50 dark:bg-red-900/30 border-red-200 dark:border-red-800'}`}>
                    <div className="flex justify-between items-center">
                      <span className="text-lg font-semibold dark:text-white">Status:</span>
                      <span className={`text-2xl font-bold ${dayData.ok ? 'text-green-700 dark:text-green-400' : 'text-red-700 dark:text-red-400'}`}>
                        {dayData.ok ? `Between Goal & BMR ‚úì` : `Outside Range ‚úó`}
                      </span>
                    </div>
                    <p className="text-sm text-gray-600 dark:text-gray-400 mt-2">
                      {dayData.ok 
                        ? `Net calories (${netCal}) were under your BMR (${dayData.bmr || settings.bmr})! üéâ` 
                        : netCal < dayData.goal 
                          ? `Net calories (${netCal}) were below your goal (${dayData.goal}). You ate ${dayData.goal - netCal} calories too few.`
                          : `Net calories (${netCal}) exceeded your BMR (${dayData.bmr || settings.bmr}). You ate ${netCal - (dayData.bmr || settings.bmr)} calories too many.`}
                    </p>
                  </div>
                  
                  <div className="flex gap-2 justify-center">
                    <button onClick={startEditDay} className="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium">Edit</button>
                    <button onClick={deleteDayEntry} className="px-6 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium">Delete</button>
                    <button onClick={() => setSelectedDay(null)} className="px-6 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white rounded-lg font-medium">Close</button>
                  </div>
                </>
              )}
            </div>
          </div>
        </div>
      );
    };

    function PotatoTracker() {
      const [view, setView] = useState('main');
      const [isDark, setIsDark] = useDarkMode();
      const [showMenu, setShowMenu] = useState(false);
      const [settings, setSettings] = useState(null);
      const [feeds, setFeeds] = useState([]);
      const [exercises, setExercises] = useState([]);
      const [history, setHistory] = useState({});
      const [weights, setWeights] = useState({});
      const [showWeightPrompt, setShowWeightPrompt] = useState(false);
      const [weightInput, setWeightInput] = useState('');
      const [selectedDay, setSelectedDay] = useState(null);
      const [inputs, setInputs] = useState({
        weight: '', heightFt: '', heightIn: '', age: '', gender: 'male',
        defPct: '18', defFlat: '', startHr: '4', endHr: '22'
      });
      const [newFeed, setNewFeed] = useState({ hour: '', cal: '', note: '' });
      const [newExercise, setNewExercise] = useState({ hour: '', cal: '', note: '' });
      const [editIdx, setEditIdx] = useState(null);
      const [editVals, setEditVals] = useState({ hour: '', cal: '', note: '' });
      const [editExIdx, setEditExIdx] = useState(null);
      const [editExVals, setEditExVals] = useState({ hour: '', cal: '', note: '' });
      
      const [showCalc, setShowCalc] = useState(false);
      const [savedFoods, setSavedFoods] = useState([]);
      const [newFood, setNewFood] = useState({ name: '', calories: '', servingSize: '' });
      const [calcItems, setCalcItems] = useState([]);
      
      // ADD THESE GOOGLE AUTH STATES:
      const [isGoogleReady, setIsGoogleReady] = useState(false);
      const [googleUser, setGoogleUser] = useState(null);
      const [accessToken, setAccessToken] = useState(null);

      // UPDATE THE AUTO-IMPORT USEEFFECT:
      useEffect(() => {
        // Check if there's import data in URL hash
        const hash = window.location.hash;
        if (hash.startsWith('#import=')) {
          const base64 = hash.substring(8);
          try {
            const data = JSON.parse(decodeURIComponent(escape(atob(base64))));
            if (confirm('Import data from URL? This will overwrite your current data.')) {
              if (data.settings) {
                setSettings(data.settings);
                localStorage.setItem('ps', JSON.stringify(data.settings));
              }
              if (data.history) {
                setHistory(data.history);
                localStorage.setItem('ph', JSON.stringify(data.history));
              }
              if (data.weights) {
                setWeights(data.weights);
                localStorage.setItem('pw', JSON.stringify(data.weights));
              }
              if (data.savedFoods) {
                setSavedFoods(data.savedFoods);
                localStorage.setItem('pfoods', JSON.stringify(data.savedFoods));
              }
              window.location.hash = '';
              window.location.reload();
            } else {
              window.location.hash = '';
            }
          } catch (e) {
            console.error('Failed to import from URL', e);
            alert('‚ùå Invalid import URL');
            window.location.hash = '';
          }
        }
      }, []);

      useEffect(() => {
        const s = localStorage.getItem('ps');
        const f = localStorage.getItem('pf');
        const ex = localStorage.getItem('pex');
        const d = localStorage.getItem('pd');
        const h = localStorage.getItem('ph');
        const w = localStorage.getItem('pw');
        const foods = localStorage.getItem('pfoods');
        const lastPrompt = localStorage.getItem('plw');
        const today = new Date().toDateString();
        
        if (s) setSettings(JSON.parse(s));
        else setView('setup');
        if (h) setHistory(JSON.parse(h));
        if (w) setWeights(JSON.parse(w));
        if (foods) setSavedFoods(JSON.parse(foods));
        
        const now = new Date();
        if (now.getDay() === 1) {
          const thisMonday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString().split('T')[0];
          if (lastPrompt !== thisMonday) {
            setShowWeightPrompt(true);
            localStorage.setItem('plw', thisMonday);
          }
        }
        
        if (f && d === today) {
          setFeeds(JSON.parse(f));
        } else if (d !== today && d && s) {
          const yest = new Date(d).toISOString().split('T')[0];
          const yf = f ? JSON.parse(f) : [];
          const yex = ex ? JSON.parse(ex) : [];
          const tot = yf.reduce((a, b) => a + b.cal, 0);
          const exTotal = yex.reduce((a, b) => a + b.cal, 0);
          const os = JSON.parse(s);
          const nh = h ? JSON.parse(h) : {};
          const netCals = tot - exTotal;
          nh[yest] = { tot, exTotal, goal: os.goal, bmr: os.bmr, ok: netCals <= os.bmr };
          setHistory(nh);
          localStorage.setItem('ph', JSON.stringify(nh));
          setFeeds([]);
          setExercises([]);
          localStorage.setItem('pf', '[]');
          localStorage.setItem('pex', '[]');
          localStorage.setItem('pd', today);
        } else {
          localStorage.setItem('pd', today);
        }
        
        if (ex && d === today) {
          setExercises(JSON.parse(ex));
        }
      }, []);

      useEffect(() => { localStorage.setItem('pf', JSON.stringify(feeds)); }, [feeds]);
      useEffect(() => { localStorage.setItem('pex', JSON.stringify(exercises)); }, [exercises]);
      useEffect(() => { localStorage.setItem('pfoods', JSON.stringify(savedFoods)); }, [savedFoods]);

      useEffect(() => {        
        // Force refresh function
        const forceRefresh = () => {
          setView(v => v);
        };
        
        // Refresh every minute
        const interval = setInterval(() => {
          forceRefresh();
        }, 60000); // 60000ms = 1 minute

        const handleVisibilityChange = () => {
          if (document.visibilityState === 'visible') {
            forceRefresh();
          }
        };
        
        // Multiple events to catch page becoming active
        document.addEventListener('visibilitychange', handleVisibilityChange);
        
        return () => {
          clearInterval(interval);
          document.removeEventListener('visibilitychange', handleVisibilityChange);
        };
      }, []);

      useEffect(() => {
        if (view === 'setup' && settings && !inputs.weight) {
          const deficit = settings.bmr - settings.goal;
          const deficitPct = ((deficit / settings.bmr) * 100).toFixed(1);
          setInputs(prev => ({
            ...prev,
            weight: settings.currentWeight?.toString() || '',
            heightFt: settings.heightFt?.toString() || '',
            heightIn: settings.heightIn?.toString() || '',
            age: settings.age?.toString() || '',
            gender: settings.gender || 'male',
            startHr: settings.start.toString(),
            endHr: settings.end.toString(),
            defPct: deficitPct,
            defFlat: deficit.toString()
          }));
        }
      }, [view, settings]);

      const calcBMR = (weight, heightFt, heightIn, age, gender) => {
        const kg = parseFloat(weight) * 0.453592;
        const cm = ((parseFloat(heightFt) * 12) + parseFloat(heightIn || 0)) * 2.54;
        const bmr = gender === 'male' ? 10 * kg + 6.25 * cm - 5 * parseFloat(age) + 5 : 10 * kg + 6.25 * cm - 5 * parseFloat(age) - 161;
        return Math.round(bmr);
      };

      const handlePct = (v) => {
        if (!inputs.weight || !inputs.heightFt || !inputs.age) { setInputs({...inputs, defPct: v, defFlat: ''}); return; }
        const bmr = calcBMR(inputs.weight, inputs.heightFt, inputs.heightIn, inputs.age, inputs.gender);
        setInputs({...inputs, defPct: v, defFlat: Math.round(bmr * parseFloat(v) / 100).toString()});
      };

      const handleFlat = (v) => {
        if (!inputs.weight || !inputs.heightFt || !inputs.age) { setInputs({...inputs, defFlat: v, defPct: ''}); return; }
        const bmr = calcBMR(inputs.weight, inputs.heightFt, inputs.heightIn, inputs.age, inputs.gender);
        setInputs({...inputs, defFlat: v, defPct: ((parseFloat(v) / bmr) * 100).toFixed(1)});
      };

      const save = () => {
        if (!inputs.weight || !inputs.heightFt || !inputs.age) return;
        const bmr = calcBMR(inputs.weight, inputs.heightFt, inputs.heightIn, inputs.age, inputs.gender);
        const def = inputs.defFlat ? parseFloat(inputs.defFlat) : Math.round(bmr * parseFloat(inputs.defPct) / 100);
        const ns = { 
          bmr, 
          goal: bmr - def, 
          start: parseInt(inputs.startHr), 
          end: parseInt(inputs.endHr),
          currentWeight: parseFloat(inputs.weight),
          heightFt: parseFloat(inputs.heightFt),
          heightIn: parseFloat(inputs.heightIn || 0),
          age: parseFloat(inputs.age),
          gender: inputs.gender,
        };
        setSettings(ns);
        localStorage.setItem('ps', JSON.stringify(ns));
        setView('main');
      };
      
    const getBudget = () => {
        if (!settings) return null;
        const hr = new Date().getHours();
        const { start, end, goal, bmr } = settings;
        const hrs = end >= start ? end - start + 1 : (24 - start) + end + 1;
        const cons = feeds.reduce((a, b) => a + b.cal, 0);
        const exCal = exercises.reduce((a, b) => a + b.cal, 0);
        const netCons = cons - exCal;
        const adjustedGoal = goal + exCal;
        const perHr = Math.round(adjustedGoal / hrs);
        const inWindow = end >= start ? hr >= start && hr <= end : hr >= start || hr <= end;
        if (!inWindow) return { msg: "Outside feasting hours", bud: 0, cons: 0, rem: 0, hr, exCal: 0, adjustedGoal, bmr };
        let passed = 0, h = start;
        while (h !== hr) { passed++; h = (h + 1) % 24; }
        passed++;
        const bud = passed * perHr;
        return { bud, cons: cons, rem: bud - cons, perHr, hr, goal, exCal, grossCons: cons, adjustedGoal, bmr };
      };

    const add = () => {
        const hour = newFeed.hour ? parseInt(newFeed.hour) : new Date().getHours();
        if (newFeed.cal) {
          setFeeds([...feeds, { hour, cal: parseInt(newFeed.cal), note: newFeed.note }]);
          setNewFeed({ hour: '', cal: '', note: '' });
        }
      };

      const addExercise = () => {
        const hour = newExercise.hour ? parseInt(newExercise.hour) : new Date().getHours();
        if (newExercise.cal) {
          setExercises([...exercises, { hour, cal: parseInt(newExercise.cal), note: newExercise.note }]);
          setNewExercise({ hour: '', cal: '', note: '' });
        }
      };

      const saveWeight = () => {
        if (weightInput && settings) {
          const today = new Date().toISOString().split('T')[0];
          const newWeights = {...weights, [today]: parseFloat(weightInput)};
          setWeights(newWeights);
          localStorage.setItem('pw', JSON.stringify(newWeights));
          
          const newBmr = calcBMR(weightInput, settings.heightFt, settings.heightIn, settings.age, settings.gender);
          const deficit = settings.bmr - settings.goal;
          const updatedSettings = {
            ...settings,
            currentWeight: parseFloat(weightInput),
            bmr: newBmr,
            goal: newBmr - deficit
          };
          setSettings(updatedSettings);
          localStorage.setItem('ps', JSON.stringify(updatedSettings));
          
          setShowWeightPrompt(false);
          setWeightInput('');
        }
      };

      const saveHistoryEdit = (date) => {
        const tot = parseInt(historyEditVals.tot);
        const exTotal = parseInt(historyEditVals.exTotal);
        const netCals = tot - exTotal;
        const newHistory = {...history};
        newHistory[date] = {
          ...newHistory[date],
          tot,
          exTotal,
          ok: (netCals >= newHistory[date].goal && netCals <= (newHistory[date].bmr || settings.bmr))
        };
        setHistory(newHistory);
        localStorage.setItem('ph', JSON.stringify(newHistory));
        setEditingHistory(null);
      };

      const addFoodToLibrary = () => {
        if (newFood.name && newFood.calories && newFood.servingSize) {
          const food = {
            id: Date.now(),
            name: newFood.name,
            caloriesPerServing: parseFloat(newFood.calories),
            servingSize: parseFloat(newFood.servingSize)
          };
          setSavedFoods([...savedFoods, food]);
          setNewFood({ name: '', calories: '', servingSize: '' });
        }
      };

      const addFoodToCalc = (food) => {
        setCalcItems([...calcItems, { ...food, grams: food.servingSize }]);
      };

      const updateCalcItemGrams = (idx, grams) => {
        const updated = [...calcItems];
        updated[idx].grams = parseFloat(grams) || 0;
        setCalcItems(updated);
      };

      const removeCalcItem = (idx) => {
        setCalcItems(calcItems.filter((_, i) => i !== idx));
      };

      const getTotalCalories = () => {
        return Math.round(calcItems.reduce((total, item) => {
          const calPerGram = item.caloriesPerServing / item.servingSize;
          return total + (calPerGram * item.grams);
        }, 0));
      };

      const applyCaloriesToFeed = () => {
        const total = getTotalCalories();
        setNewFeed({ ...newFeed, cal: total.toString() });
        setShowCalc(false);
        setCalcItems([]);
      };

      const deleteSavedFood = (id) => {
        setSavedFoods(savedFoods.filter(f => f.id !== id));
      };

      const quick = (amt) => setFeeds([...feeds, { hour: new Date().getHours(), cal: amt, note: '' }]);
      const quickEx = (amt) => setExercises([...exercises, { hour: new Date().getHours(), cal: amt, note: '' }]);
      const del = (i) => { setFeeds(feeds.filter((_, idx) => idx !== i)); setEditIdx(null); };
      const delEx = (i) => { setExercises(exercises.filter((_, idx) => idx !== i)); setEditExIdx(null); };
      
      const startEdit = (i) => { 
        setEditIdx(i); 
        setEditVals({ hour: feeds[i].hour.toString(), cal: feeds[i].cal.toString(), note: feeds[i].note }); 
      };
      
      const saveEdit = (i) => {
        const u = [...feeds];
        u[i] = { hour: parseInt(editVals.hour), cal: parseInt(editVals.cal), note: editVals.note };
        setFeeds(u);
        setEditIdx(null);
      };

      const startEditEx = (i) => { 
        setEditExIdx(i); 
        setEditExVals({ hour: exercises[i].hour.toString(), cal: exercises[i].cal.toString(), note: exercises[i].note }); 
      };
      
      const saveEditEx = (i) => {
        const u = [...exercises];
        u[i] = { hour: parseInt(editExVals.hour), cal: parseInt(editExVals.cal), note: editExVals.note };
        setExercises(u);
        setEditExIdx(null);
      };

      const getStreak = () => {
        const d = Object.keys(history).sort().reverse();
        let s = 0, c = new Date();
        c.setDate(c.getDate() - 1);
        for (let i = 0; i < d.length; i++) {
          const k = c.toISOString().split('T')[0];
          if (d[i] === k && history[k].ok) { s++; c.setDate(c.getDate() - 1); }
          else break;
        }
        return s;
      };

      const getWeekly = () => {
        const w = new Date();
        w.setDate(w.getDate() - 7);
        const d = Object.entries(history).filter(([dt]) => new Date(dt) >= w);
        if (!d.length) return null;
        return {
          avg: Math.round(d.reduce((a, [, v]) => a + v.tot - (v.exTotal || 0), 0) / d.length),
          avgRem: Math.round(d.reduce((a, [, v]) => a + ((v.bmr || settings.bmr) - (v.tot - (v.exTotal || 0))), 0) / d.length),
          ok: d.filter(([, v]) => v.ok).length,
          tot: d.length
        };
      };

      const getCalendarMonths = () => {
        const dates = Object.keys(history);
        if (dates.length === 0) return [];
        
        const sortedDates = dates.sort();
        const firstDate = new Date(sortedDates[0]);
        const lastDate = new Date(sortedDates[sortedDates.length - 1]);
        
        const months = [];
        let current = new Date(firstDate.getFullYear(), firstDate.getMonth(), 1);
        const end = new Date(lastDate.getFullYear(), lastDate.getMonth(), 1);
        
        while (current <= end) {
          months.push(new Date(current));
          current.setMonth(current.getMonth() + 1);
        }
        
        return months;
      };

      const getDaysInMonth = (year, month) => {
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        
        const days = [];
        
        for (let i = 0; i < startingDayOfWeek; i++) {
          days.push(null);
        }
        
        for (let day = 1; day <= daysInMonth; day++) {
          days.push(new Date(year, month, day));
        }
        
        return days;
      };

      // REPLACE THE EXPORT/IMPORT FUNCTIONS WITH THESE:
      const handleExport = async () => {
        const data = {
          settings,
          history,
          weights,
          savedFoods,
          exportDate: new Date().toISOString()
        };
        
        const jsonStr = JSON.stringify(data);
        const base64 = btoa(unescape(encodeURIComponent(jsonStr)));
        const fullUrl = window.location.origin + window.location.pathname + '#import=' + base64;
        
        try {
          // Use is.gd URL shortener (HTTPS supported, no API key needed)
          const response = await fetch(`https://is.gd/create.php?format=simple&url=${encodeURIComponent(fullUrl)}`);
          
          if (!response.ok) throw new Error('Shortener failed');
          
          const shortUrl = await response.text();
          
          // Copy to clipboard and show alert
          await navigator.clipboard.writeText(shortUrl);
          alert(`‚úÖ Short URL copied to clipboard!\n\n${shortUrl}\n\nShare this link to sync your data across devices.`);
        } catch (error) {
          console.error('URL shortener error:', error);
          // Fallback: just copy the full URL
          try {
            await navigator.clipboard.writeText(fullUrl);
            alert('‚ö†Ô∏è Could not create short URL.\n\nFull URL copied to clipboard instead.\n\n(It works but is very long)');
          } catch {
            // Final fallback: download JSON file
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `potato-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert('‚ö†Ô∏è Could not create short URL or copy to clipboard.\n\nDownloaded backup file instead.');
          }
        }
      };

      const handleImport = async () => {
        const input = prompt('Paste your short URL or import data:');
        if (!input) return;
        
        try {
          let data;
          
          // Check if it's a URL
          if (input.startsWith('http')) {
            // Try to extract hash directly if it's our full URL
            if (input.includes('#import=')) {
              const hash = input.split('#import=')[1];
              data = JSON.parse(decodeURIComponent(escape(atob(hash))));
            } else {
              // It's a short URL, we need to follow it
              // For short URLs, user needs to open in browser then import will auto-trigger
              alert('Please open that URL in your browser - it will automatically prompt to import the data.');
              return;
            }
          } else if (input.startsWith('{')) {
            // Direct JSON input
            data = JSON.parse(input);
          } else {
            // Assume it's base64
            data = JSON.parse(decodeURIComponent(escape(atob(input))));
          }
          
          // Import data
          if (data.settings) {
            setSettings(data.settings);
            localStorage.setItem('ps', JSON.stringify(data.settings));
          }
          if (data.history) {
            setHistory(data.history);
            localStorage.setItem('ph', JSON.stringify(data.history));
          }
          if (data.weights) {
            setWeights(data.weights);
            localStorage.setItem('pw', JSON.stringify(data.weights));
          }
          if (data.savedFoods) {
            setSavedFoods(data.savedFoods);
            localStorage.setItem('pfoods', JSON.stringify(data.savedFoods));
          }
          
          alert('‚úÖ Data imported successfully!');
          window.location.reload();
        } catch (error) {
          alert('‚ùå Failed to import data. Make sure you pasted the correct URL or data.');
          console.error(error);
        }
      };
      
      // GOOGLE DRIVE SYNC FUNCTIONS
      const CLIENT_ID = '875128652743-rmm519amdl1frs3rg3rkr73bni8t8ulp.apps.googleusercontent.com';
      const SCOPES = 'https://www.googleapis.com/auth/drive.file';
      const FILE_NAME = 'potato-tracker-data.json';

      useEffect(() => {
        // Initialize Google Sign-In
        const initGoogleAuth = () => {
          if (window.google) {
            setIsGoogleReady(true);
            
            // Check if user was previously signed in
            const storedToken = localStorage.getItem('googleAccessToken');
            const tokenExpiry = localStorage.getItem('googleTokenExpiry');
            
            if (storedToken && tokenExpiry) {
              const now = Date.now();
              if (now < parseInt(tokenExpiry)) {
                // Token is still valid
                setAccessToken(storedToken);
                loadFromDrive(storedToken);
              } else {
                // Token expired, clear it
                localStorage.removeItem('googleAccessToken');
                localStorage.removeItem('googleTokenExpiry');
              }
            }
          }
        };

        if (window.google) {
          initGoogleAuth();
        } else {
          window.addEventListener('load', initGoogleAuth);
        }

        return () => window.removeEventListener('load', initGoogleAuth);
      }, []);

      const handleGoogleSignIn = () => {
        const client = window.google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: (response) => {
            if (response.access_token) {
              setAccessToken(response.access_token);
              localStorage.setItem('googleAccessToken', response.access_token);
              
              // Store expiry time (tokens last about 1 hour)
              const expiryTime = Date.now() + (response.expires_in || 3600) * 1000;
              localStorage.setItem('googleTokenExpiry', expiryTime.toString());
              
              alert('‚úÖ Signed in! Use Upload/Download buttons to sync your data.');
            }
          },
        });
        client.requestAccessToken();
      };

      const handleGoogleSignOut = () => {
        setAccessToken(null);
        setGoogleUser(null);
        localStorage.removeItem('googleAccessToken');
        localStorage.removeItem('googleTokenExpiry');
        alert('‚úÖ Signed out from Google Drive sync');
      };

      const handleUploadToDrive = async () => {
        if (!accessToken) {
          alert('Please sign in first');
          return;
        }
        
        if (confirm('Upload your current data to Google Drive? This will overwrite what\'s stored in Drive.')) {
          await saveToDrive(accessToken);
          alert('‚úÖ Uploaded to Google Drive!');
        }
      };

      const handleDownloadFromDrive = async () => {
        if (!accessToken) {
          alert('Please sign in first');
          return;
        }
        
        if (confirm('Download data from Google Drive? This will overwrite your current local data.')) {
          await loadFromDrive(accessToken);
          window.location.reload();
        }
      };

      const saveToDrive = async (token) => {
        const data = {
          settings,
          history,
          weights,
          savedFoods,
          feeds,
          exercises,
          lastSync: new Date().toISOString()
        };

        try {
          // First, try to find existing file
          const searchResponse = await fetch(
            `https://www.googleapis.com/drive/v3/files?q=name='${FILE_NAME}' and trashed=false`,
            {
              headers: { Authorization: `Bearer ${token}` }
            }
          );
          const searchData = await searchResponse.json();

          const metadata = {
            name: FILE_NAME,
            mimeType: 'application/json'
          };

          const file = new Blob([JSON.stringify(data)], { type: 'application/json' });
          const form = new FormData();

          if (searchData.files && searchData.files.length > 0) {
            // Update existing file
            const fileId = searchData.files[0].id;
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`, {
              method: 'PATCH',
              headers: { Authorization: `Bearer ${token}` },
              body: form
            });
          } else {
            // Create new file
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
              method: 'POST',
              headers: { Authorization: `Bearer ${token}` },
              body: form
            });
          }

          console.log('‚úÖ Synced to Google Drive');
        } catch (error) {
          console.error('Failed to sync to Drive:', error);
          alert('‚ö†Ô∏è Failed to sync to Google Drive. You may need to sign in again.');
          setAccessToken(null);
          localStorage.removeItem('googleAccessToken');
        }
      };

      const loadFromDrive = async (token) => {
        try {
          // Find the file
          const searchResponse = await fetch(
            `https://www.googleapis.com/drive/v3/files?q=name='${FILE_NAME}' and trashed=false`,
            {
              headers: { Authorization: `Bearer ${token}` }
            }
          );
          const searchData = await searchResponse.json();

          if (searchData.files && searchData.files.length > 0) {
            const fileId = searchData.files[0].id;

            // Download file content
            const contentResponse = await fetch(
              `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
              {
                headers: { Authorization: `Bearer ${token}` }
              }
            );
            const data = await contentResponse.json();

            // Load all data from Drive
            if (data.settings) {
              setSettings(data.settings);
              localStorage.setItem('ps', JSON.stringify(data.settings));
            }
            if (data.history) {
              setHistory(data.history);
              localStorage.setItem('ph', JSON.stringify(data.history));
            }
            if (data.weights) {
              setWeights(data.weights);
              localStorage.setItem('pw', JSON.stringify(data.weights));
            }
            if (data.savedFoods) {
              setSavedFoods(data.savedFoods);
              localStorage.setItem('pfoods', JSON.stringify(data.savedFoods));
            }
            if (data.feeds) {
              setFeeds(data.feeds);
              localStorage.setItem('pf', JSON.stringify(data.feeds));
            }
            if (data.exercises) {
              setExercises(data.exercises);
              localStorage.setItem('pex', JSON.stringify(data.exercises));
            }
            
            const today = new Date().toDateString();
            localStorage.setItem('pd', today);
            localStorage.setItem('lastSync', new Date().toISOString());
            
            console.log('‚úÖ Downloaded from Google Drive');
          } else {
            alert('No backup found in Google Drive. Use Upload to create one.');
          }
        } catch (error) {
          console.error('Failed to load from Drive:', error);
          alert('‚ö†Ô∏è Failed to download from Google Drive.');
        }
      };

      const b = getBudget();
      const st = getStreak();
      const ws = getWeekly();
      const prog = b && b.adjustedGoal ? Math.min((b.cons / b.adjustedGoal) * 100, 100) : 0;

      if (showCalc) {
        return (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
              <div className="sticky top-0 bg-white dark:bg-gray-800 border-b dark:border-gray-700 p-6 flex justify-between items-center">
                <h2 className="text-2xl font-bold dark:text-white">üßÆ Calorie Calculator</h2>
                <button onClick={() => { setShowCalc(false); setCalcItems([]); }} className="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 text-2xl">&times;</button>
              </div>
              
              <div className="p-6 space-y-6">
                <div className="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-4">
                  <h3 className="font-semibold mb-3 dark:text-white">Add New Food to Library</h3>
                  <div className="grid grid-cols-4 gap-3">
                    <div className="col-span-2">
                      <label className="block text-sm font-medium mb-1 dark:text-gray-300">Food Name</label>
                      <input type="text" value={newFood.name} onChange={(e) => setNewFood({...newFood, name: e.target.value})} placeholder="Gold Potato" className="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1 dark:text-gray-300">Calories</label>
                      <input type="number" step="0.1" value={newFood.calories} onChange={(e) => setNewFood({...newFood, calories: e.target.value})} placeholder="40" className="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1 dark:text-gray-300">Serving (g)</label>
                      <input type="number" step="0.1" value={newFood.servingSize} onChange={(e) => setNewFood({...newFood, servingSize: e.target.value})} placeholder="50" className="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg" />
                    </div>
                  </div>
                  <button onClick={addFoodToLibrary} className="mt-3 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium">Add to Library</button>
                </div>

                <div>
                  <h3 className="font-semibold mb-3 dark:text-white">Food Library</h3>
                  {savedFoods.length === 0 ? (
                    <p className="text-gray-500 dark:text-gray-400 text-center py-4">No saved foods yet. Add some above!</p>
                  ) : (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                      {savedFoods.map((food) => (
                        <div key={food.id} className="flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                          <div className="flex-1">
                            <p className="font-medium dark:text-white">{food.name}</p>
                            <p className="text-sm text-gray-600 dark:text-gray-400">{food.caloriesPerServing}cal / {food.servingSize}g</p>
                          </div>
                          <div className="flex gap-2">
                            <button onClick={() => addFoodToCalc(food)} className="px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded text-sm font-medium">Add</button>
                            <button onClick={() => deleteSavedFood(food.id)} className="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm font-medium">√ó</button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                <div className="border-t dark:border-gray-700 pt-6">
                  <h3 className="font-semibold mb-3 dark:text-white">Current Meal Calculation</h3>
                  {calcItems.length === 0 ? (
                    <p className="text-gray-500 dark:text-gray-400 text-center py-4">Add foods from your library above</p>
                  ) : (
                    <div className="space-y-3">
                      {calcItems.map((item, idx) => {
                        const calPerGram = item.caloriesPerServing / item.servingSize;
                        const itemTotal = Math.round(calPerGram * item.grams);
                        return (
                          <div key={idx} className="bg-amber-50 dark:bg-amber-900/30 p-3 rounded-lg">
                            <div className="flex items-center gap-3">
                              <div className="flex-1">
                                <p className="font-medium dark:text-white">{item.name}</p>
                                <p className="text-xs text-gray-600 dark:text-gray-400">{item.caloriesPerServing}cal / {item.servingSize}g = {calPerGram.toFixed(2)}cal/g</p>
                              </div>
                              <div className="w-32">
                                <input type="number" step="0.1" value={item.grams} onChange={(e) => updateCalcItemGrams(idx, e.target.value)} className="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg text-center" />
                                <p className="text-xs text-gray-600 dark:text-gray-400 text-center mt-1">grams</p>
                              </div>
                              <div className="w-20 text-right">
                                <p className="text-lg font-bold text-orange-600 dark:text-orange-400">{itemTotal}</p>
                                <p className="text-xs text-gray-600 dark:text-gray-400">cal</p>
                              </div>
                              <button onClick={() => removeCalcItem(idx)} className="text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 font-bold text-xl">√ó</button>
                            </div>
                          </div>
                        );
                      })}
                      
                      <div className="bg-orange-100 dark:bg-orange-900/40 border-2 border-orange-300 dark:border-orange-700 p-4 rounded-lg">
                        <div className="flex justify-between items-center">
                          <span className="text-lg font-semibold dark:text-white">Total Calories:</span>
                          <span className="text-3xl font-bold text-orange-700 dark:text-orange-400">{getTotalCalories()}</span>
                        </div>
                      </div>
                      
                      <button onClick={applyCaloriesToFeed} className="w-full py-3 bg-orange-500 hover:bg-orange-600 text-white font-bold rounded-lg text-lg">
                        Apply {getTotalCalories()} Calories to Feed
                      </button>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      }

      if (showWeightPrompt) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 dark:from-gray-900 dark:to-gray-800 p-6 flex items-center justify-center">
            <div className="max-w-md w-full bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8">
              <h2 className="text-2xl font-bold text-gray-800 dark:text-white mb-4">‚öñÔ∏è Monday Weigh-In</h2>
              <p className="text-gray-600 dark:text-gray-300 mb-4">Track your progress! What's your current weight?</p>
              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Weight (lbs)</label>
                <input type="number" step="0.1" value={weightInput} onChange={(e) => setWeightInput(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:ring-2 focus:ring-orange-500" />
              </div>
              <p className="text-sm text-gray-600 dark:text-gray-400 mb-4">üí° Your BMR and daily goal will be automatically recalculated based on your new weight.</p>
              <div className="flex gap-2">
                <button onClick={saveWeight} className="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 rounded-lg">Save Weight</button>
                <button onClick={() => setShowWeightPrompt(false)} className="px-4 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white rounded-lg">Skip</button>
              </div>
            </div>
          </div>
        );
      }

      if (view === 'weights') {
        const sortedWeights = Object.entries(weights).sort(([a], [b]) => b.localeCompare(a));
        const latestWeight = sortedWeights.length > 0 ? sortedWeights[0][1] : null;
        const oldestWeight = sortedWeights.length > 0 ? sortedWeights[sortedWeights.length - 1][1] : null;
        const weightChange = latestWeight && oldestWeight ? (latestWeight - oldestWeight).toFixed(1) : null;
        
        const chartData = sortedWeights.slice().reverse();
        const minWeight = chartData.length > 0 ? Math.min(...chartData.map(([, w]) => w)) : 0;
        const maxWeight = chartData.length > 0 ? Math.max(...chartData.map(([, w]) => w)) : 0;
        const weightRange = maxWeight - minWeight || 10;
        const chartHeight = 200;
        const chartWidth = 600;
        const padding = 40;
        
        const getX = (index) => padding + (index / (chartData.length - 1 || 1)) * (chartWidth - 2 * padding);
        const getY = (weight) => chartHeight - padding - ((weight - minWeight + weightRange * 0.1) / (weightRange * 1.2)) * (chartHeight - 2 * padding);
        
        const pathD = chartData.map(([date, weight], i) => 
          `${i === 0 ? 'M' : 'L'} ${getX(i)} ${getY(weight)}`
        ).join(' ');
        
        return (
          <WeightView 
            sortedWeights={sortedWeights}
            latestWeight={latestWeight}
            oldestWeight={oldestWeight}
            weightChange={weightChange}
            chartData={chartData}
            pathD={pathD}
            getX={getX}
            getY={getY}
            chartWidth={chartWidth}
            chartHeight={chartHeight}
            padding={padding}
            weights={weights}
            setWeights={setWeights}
            settings={settings}
            setSettings={setSettings}
            calcBMR={calcBMR}
            setView={setView}
          />
        );
      }

      if (selectedDay) {
        const dayData = history[selectedDay];
        const date = new Date(selectedDay);
        const netCal = dayData.tot - (dayData.exTotal || 0);
        
        return (
          <DayDetailModal 
            selectedDay={selectedDay}
            dayData={dayData}
            date={date}
            netCal={netCal}
            history={history}
            setHistory={setHistory}
            settings={settings}
            setSelectedDay={setSelectedDay}
          />
        );
      }

    if (view === 'history') {
        const months = getCalendarMonths();
        
        // Calculate weekly stats
        const getWeeklyStats = () => {
          const weeks = {};
          
          // Get all dates and find the range
          const allDates = Object.keys(history).sort();
          if (allDates.length === 0) return [];
          
          // Generate all weeks that contain data
          allDates.forEach(dateStr => {
            const date = new Date(dateStr + 'T00:00:00');
            // Get Monday of that week (weeks run Monday-Sunday)
            const dayOfWeek = date.getDay(); // 0=Sun, 1=Mon, 2=Tue, etc.
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // If Sunday, go back 6 days; otherwise go back to Monday
            const monday = new Date(date);
            monday.setDate(monday.getDate() + diff);
            const weekKey = monday.toISOString().split('T')[0];
            
            if (!weeks[weekKey]) {
              weeks[weekKey] = {
                dates: [],
                totalFood: 0,
                totalExercise: 0,
                totalNet: 0,
                totalBMR: 0,
                successDays: 0,
                weekStart: new Date(monday),
                actualWeightStart: null,
                actualWeightEnd: null
              };
            }
            
            const dayData = history[dateStr];
            const netCal = dayData.tot - (dayData.exTotal || 0);
            
            weeks[weekKey].dates.push(dateStr);
            weeks[weekKey].totalFood += dayData.tot;
            weeks[weekKey].totalExercise += (dayData.exTotal || 0);
            weeks[weekKey].totalNet += netCal;
            weeks[weekKey].totalBMR += (dayData.bmr || settings?.bmr || 0);
            if (dayData.ok) weeks[weekKey].successDays++;
            
            // Check for weight entries at start and end of week
            const sortedDates = weeks[weekKey].dates.sort();
            const firstDate = sortedDates[0];
            const lastDate = sortedDates[sortedDates.length - 1];
            
            // Check for weight at the beginning of the week (Monday of this week)
            if (weights[firstDate]) {
              weeks[weekKey].actualWeightStart = weights[firstDate];
            }
            
            // Check for weight on the Monday AFTER this week ends (which represents the end weight)
            const nextMonday = new Date(monday);
            nextMonday.setDate(nextMonday.getDate() + 7);
            const nextMondayStr = nextMonday.toISOString().split('T')[0];
            if (weights[nextMondayStr]) {
              weeks[weekKey].actualWeightEnd = weights[nextMondayStr];
            }
          });
          
          return Object.entries(weeks).sort(([a], [b]) => b.localeCompare(a));
        };
        
        const weeklyStats = getWeeklyStats();
        
        return (
          <div className="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 dark:from-gray-900 dark:to-gray-800 p-6">
            <div className="max-w-6xl mx-auto space-y-6">
              <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8">
                <div className="flex justify-between items-center mb-6">
                  <h1 className="text-3xl font-bold text-gray-800 dark:text-white flex items-center gap-2"><Calendar />History Calendar</h1>
                  <button onClick={() => setView('main')} className="px-4 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white rounded-lg">Back</button>
                </div>
                
                {months.length === 0 ? (
                  <p className="text-center py-12 text-gray-500 dark:text-gray-400">No history yet! Start tracking your feeds.</p>
                ) : (
                  <div className="space-y-8">
                    {months.map(monthDate => {
                      const year = monthDate.getFullYear();
                      const month = monthDate.getMonth();
                      const days = getDaysInMonth(year, month);
                      const monthName = monthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                      
                      return (
                        <div key={`${year}-${month}`} className="bg-gradient-to-br from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-lg p-6">
                          <h2 className="text-2xl font-bold mb-4 dark:text-white">{monthName}</h2>
                          <div className="grid grid-cols-7 gap-2">
                            {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                              <div key={day} className="text-center font-semibold text-gray-600 dark:text-gray-400 text-sm py-2">
                                {day}
                              </div>
                            ))}
                            {days.map((day, idx) => {
                              if (!day) {
                                return <div key={`empty-${idx}`} className="aspect-square" />;
                              }
                              
                              const dateStr = day.toISOString().split('T')[0];
                              const dayData = history[dateStr];
                              const isToday = dateStr === new Date().toISOString().split('T')[0];
                              
                              if (!dayData) {
                                return (
                                  <div key={dateStr} className={`aspect-square flex items-center justify-center rounded-lg border-2 ${isToday ? 'border-blue-400 dark:border-blue-500 bg-blue-100 dark:bg-blue-900/40' : 'border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800'}`}>
                                    <span className="text-gray-400 dark:text-gray-500 text-sm">{day.getDate()}</span>
                                  </div>
                                );
                              }
                              
                              const netCal = dayData.tot - (dayData.exTotal || 0);
                              const isSuccess = dayData.ok;
                              
                              return (
                                <button
                                  key={dateStr}
                                  onClick={() => setSelectedDay(dateStr)}
                                  className={`aspect-square flex flex-col items-center justify-center rounded-lg border-2 transition-all hover:scale-105 ${
                                    isSuccess 
                                      ? 'bg-green-100 dark:bg-green-900/40 border-green-400 dark:border-green-700 hover:bg-green-200 dark:hover:bg-green-900/60' 
                                      : 'bg-red-100 dark:bg-red-900/40 border-red-400 dark:border-red-700 hover:bg-red-200 dark:hover:bg-red-900/60'
                                  } ${isToday ? 'ring-2 ring-blue-500 dark:ring-blue-400' : ''}`}
                                >
                                  <span className="font-bold text-lg dark:text-white">{day.getDate()}</span>
                                  <span className="text-xs font-semibold mt-1 dark:text-gray-200">{netCal}</span>
                                </button>
                              );
                            })}
                          </div>
                        </div>
                      );
                    })}
                    
                    <div className="bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg p-4">
                      <h3 className="font-semibold mb-3 dark:text-white">Legend</h3>
                      <div className="flex flex-wrap gap-4">
                        <div className="flex items-center gap-2">
                          <div className="w-8 h-8 bg-green-100 dark:bg-green-900/40 border-2 border-green-400 dark:border-green-700 rounded"></div>
                          <span className="text-sm dark:text-gray-300">Success (Under BMR)</span>
                        </div>
                        <div className="flex items-center gap-2">
                          <div className="w-8 h-8 bg-red-100 dark:bg-red-900/40 border-2 border-red-400 dark:border-red-700 rounded"></div>
                          <span className="text-sm dark:text-gray-300">Failed (Over BMR)</span>
                        </div>
                        <div className="flex items-center gap-2">
                          <div className="w-8 h-8 bg-blue-100 dark:bg-blue-900/40 border-2 border-blue-400 dark:border-blue-500 rounded"></div>
                          <span className="text-sm dark:text-gray-300">Today</span>
                        </div>
                        <div className="flex items-center gap-2">
                          <div className="w-8 h-8 bg-white dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-700 rounded"></div>
                          <span className="text-sm dark:text-gray-300">No Data</span>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
              
              {/* Weekly Stats Section */}
              {weeklyStats.length > 0 && (
                <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8">
                  <h2 className="text-2xl font-bold mb-6 dark:text-white">üìä Weekly Summary</h2>
                  <div className="space-y-4">
                    {weeklyStats.map(([weekKey, stats]) => {
                      const weekEnd = new Date(stats.weekStart);
                      weekEnd.setDate(weekEnd.getDate() + 6);
                      const weekLabel = `${stats.weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
                      
                      const deficit = stats.totalBMR - stats.totalNet;
                      const estimatedLoss = (deficit / 3500).toFixed(2);
                      const actualLoss = stats.actualWeightStart && stats.actualWeightEnd 
                        ? (stats.actualWeightStart - stats.actualWeightEnd).toFixed(2) 
                        : null;
                      
                      const isCurrentWeek = new Date() >= stats.weekStart && new Date() <= weekEnd;
                      
                      return (
                        <div key={weekKey} className={`border-2 rounded-lg p-6 ${isCurrentWeek ? 'border-blue-400 dark:border-blue-600 bg-blue-50 dark:bg-blue-900/20' : 'border-gray-200 dark:border-gray-700'}`}>
                          <div className="flex justify-between items-start mb-4">
                            <div>
                              <h3 className="text-xl font-bold dark:text-white">{weekLabel}</h3>
                              {isCurrentWeek && <span className="text-sm text-blue-600 dark:text-blue-400 font-medium">Current Week</span>}
                            </div>
                            <div className="text-right">
                              <p className="text-sm text-gray-600 dark:text-gray-400">Success Rate</p>
                              <p className="text-2xl font-bold text-green-600 dark:text-green-400">{stats.successDays}/{stats.dates.length}</p>
                            </div>
                          </div>
                          
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div className="bg-orange-50 dark:bg-orange-900/30 rounded-lg p-3">
                              <p className="text-xs text-gray-600 dark:text-gray-400 mb-1">Food Consumed</p>
                              <p className="text-xl font-bold text-orange-700 dark:text-orange-400">{stats.totalFood.toLocaleString()}</p>
                              <p className="text-xs text-gray-500 dark:text-gray-500">calories</p>
                            </div>
                            <div className="bg-green-50 dark:bg-green-900/30 rounded-lg p-3">
                              <p className="text-xs text-gray-600 dark:text-gray-400 mb-1">Exercise Burned</p>
                              <p className="text-xl font-bold text-green-700 dark:text-green-400">{stats.totalExercise.toLocaleString()}</p>
                              <p className="text-xs text-gray-500 dark:text-gray-500">calories</p>
                            </div>
                            <div className="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-3">
                              <p className="text-xs text-gray-600 dark:text-gray-400 mb-1">Net Calories</p>
                              <p className="text-xl font-bold text-blue-700 dark:text-blue-400">{stats.totalNet.toLocaleString()}</p>
                              <p className="text-xs text-gray-500 dark:text-gray-500">food - exercise</p>
                            </div>
                            <div className="bg-purple-50 dark:bg-purple-900/30 rounded-lg p-3">
                              <p className="text-xs text-gray-600 dark:text-gray-400 mb-1">BMR Budget</p>
                              <p className="text-xl font-bold text-purple-700 dark:text-purple-400">{stats.totalBMR.toLocaleString()}</p>
                              <p className="text-xs text-gray-500 dark:text-gray-500">total allowed</p>
                            </div>
                          </div>
                          
                          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className={`rounded-lg p-4 ${deficit >= 0 ? 'bg-green-100 dark:bg-green-900/30 border-2 border-green-300 dark:border-green-700' : 'bg-red-100 dark:bg-red-900/30 border-2 border-red-300 dark:border-red-700'}`}>
                              <p className="text-sm font-medium dark:text-white mb-1">Calorie Deficit</p>
                              <p className={`text-2xl font-bold ${deficit >= 0 ? 'text-green-700 dark:text-green-400' : 'text-red-700 dark:text-red-400'}`}>
                                {deficit >= 0 ? '+' : ''}{deficit.toLocaleString()}
                              </p>
                              <p className="text-xs text-gray-600 dark:text-gray-400 mt-1">
                                {deficit >= 0 ? 'under BMR' : 'over BMR'}
                              </p>
                            </div>
                            
                            <div className="bg-amber-100 dark:bg-amber-900/30 rounded-lg p-4 border-2 border-amber-300 dark:border-amber-700">
                              <p className="text-sm font-medium dark:text-white mb-1">Est. Weight Loss</p>
                              <p className="text-2xl font-bold text-amber-700 dark:text-amber-400">
                                {parseFloat(estimatedLoss) >= 0 ? estimatedLoss : '0.00'} lbs
                              </p>
                              <p className="text-xs text-gray-600 dark:text-gray-400 mt-1">
                                {deficit} √∑ 3,500 cal/lb
                              </p>
                            </div>
                            
                            {actualLoss !== null ? (
                              <div className={`rounded-lg p-4 border-2 ${
                                parseFloat(actualLoss) >= parseFloat(estimatedLoss) 
                                  ? 'bg-green-100 dark:bg-green-900/30 border-green-300 dark:border-green-700' 
                                  : 'bg-yellow-100 dark:bg-yellow-900/30 border-yellow-300 dark:border-yellow-700'
                              }`}>
                                <p className="text-sm font-medium dark:text-white mb-1">Actual Weight Loss</p>
                                <p className={`text-2xl font-bold ${
                                  parseFloat(actualLoss) >= parseFloat(estimatedLoss) 
                                    ? 'text-green-700 dark:text-green-400' 
                                    : 'text-yellow-700 dark:text-yellow-400'
                                }`}>
                                  {actualLoss} lbs {parseFloat(actualLoss) >= parseFloat(estimatedLoss) ? '‚úì' : ''}
                                </p>
                                <p className="text-xs text-gray-600 dark:text-gray-400 mt-1">
                                  {stats.actualWeightStart} ‚Üí {stats.actualWeightEnd} lbs
                                </p>
                              </div>
                            ) : (
                              <div className="bg-gray-100 dark:bg-gray-700/50 rounded-lg p-4 border-2 border-gray-300 dark:border-gray-600">
                                <p className="text-sm font-medium dark:text-white mb-1">Actual Weight Loss</p>
                                <p className="text-2xl font-bold text-gray-500 dark:text-gray-400">--</p>
                                <p className="text-xs text-gray-600 dark:text-gray-400 mt-1">No weight data</p>
                              </div>
                            )}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      if (view === 'setup' || !settings) {
        const canCalc = inputs.weight && inputs.heightFt && inputs.age;
        const bmr = canCalc ? calcBMR(inputs.weight, inputs.heightFt, inputs.heightIn, inputs.age, inputs.gender) : null;
        return (
          <div className="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 dark:from-gray-900 dark:to-gray-800 p-6">
            <div className="max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8">
              <div className="flex items-center gap-3 mb-6">
                <div className="text-4xl">ü•î</div>
                <h1 className="text-3xl font-bold dark:text-white">Potato Tracker Setup</h1>
              </div>
              <div className="space-y-6">
                <div className="bg-amber-50 dark:bg-amber-900/30 p-6 rounded-lg space-y-4">
                  <h2 className="text-xl font-semibold flex items-center gap-2 dark:text-white"><Calculator />Calculate BMR</h2>
                  <div className="grid grid-cols-2 gap-4">
                    <div><label className="block text-sm font-medium mb-1 dark:text-gray-300">Weight (lbs)</label><input type="number" step="0.1" value={inputs.weight} onChange={(e) => setInputs({...inputs, weight: e.target.value})} onBlur={() => inputs.defPct && canCalc && handlePct(inputs.defPct)} className="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg" /></div>
                    <div><label className="block text-sm font-medium mb-1 dark:text-gray-300">Height</label><div className="flex gap-2"><input type="number" min="0" max="8" value={inputs.heightFt} placeholder="ft" onChange={(e) => setInputs({...inputs, heightFt: e.target.value})} onBlur={() => inputs.defPct && canCalc && handlePct(inputs.defPct)} className="flex-1 px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg" /><input type="number" min="0" max="11" value={inputs.heightIn} placeholder="in" onChange={(e) => setInputs({...inputs, heightIn: e.target.value})} onBlur={() => inputs.defPct && canCalc && handlePct(inputs.defPct)} className="flex-1 px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg" /></div></div>
                    <div><label className="block text-sm font-medium mb-1 dark:text-gray-300">Age</label><input type="number" value={inputs.age} onChange={(e) => setInputs({...inputs, age: e.target.value})} onBlur={() => inputs.defPct && canCalc && handlePct(inputs.defPct)} className="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg" /></div>
                    <div><label className="block text-sm font-medium mb-1 dark:text-gray-300">Gender</label><select value={inputs.gender} onChange={(e) => setInputs({...inputs, gender: e.target.value})} className="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg"><option value="male">Male</option><option value="female">Female</option></select></div>
                  </div>
                  {bmr && <div className="bg-white dark:bg-gray-700 p-3 rounded border dark:border-gray-600"><p className="text-sm dark:text-gray-300"><span className="font-semibold">BMR:</span> {bmr} cal/day</p></div>}
                </div>
                <div className="space-y-4">
                  <div><label className="block text-sm font-medium mb-1 dark:text-gray-300">Calorie Deficit</label><div className="grid grid-cols-2 gap-3"><div><input type="number" min="0" max="50" step="0.1" value={inputs.defPct} onChange={(e) => handlePct(e.target.value)} placeholder="%" className="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg" /><p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Percent (%)</p></div><div><input type="number" min="0" value={inputs.defFlat} onChange={(e) => handleFlat(e.target.value)} placeholder="Cal" className="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg" /><p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Flat (cal)</p></div></div>{bmr && inputs.defFlat && <p className="text-sm mt-2 dark:text-gray-300"><span className="font-semibold">Goal:</span> {bmr - parseInt(inputs.defFlat)} cal</p>}</div>
                  <div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-medium mb-1 dark:text-gray-300">Start Hour</label><input type="number" min="0" max="23" value={inputs.startHr} onChange={(e) => setInputs({...inputs, startHr: e.target.value})} className="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg" /></div><div><label className="block text-sm font-medium mb-1 dark:text-gray-300">End Hour</label><input type="number" min="0" max="23" value={inputs.endHr} onChange={(e) => setInputs({...inputs, endHr: e.target.value})} className="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg" /></div></div>
                </div>
                <button onClick={save} className="w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 rounded-lg">Save Settings</button>
              </div>
            </div>
          </div>
        );
      }

    return (
        <div className="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 dark:from-gray-900 dark:to-gray-800 p-6">
          <div className="max-w-4xl mx-auto space-y-6">
            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8">
              <div className="flex justify-between items-center mb-6">
                <div><h1 className="text-3xl font-bold dark:text-white">ü•î Potato Tracker</h1>{b && <p className="text-sm text-gray-500 dark:text-gray-400">Time: {b.hr}:00</p>}</div>
                <div className="flex gap-2">
                  <button onClick={() => setShowMenu(!showMenu)} className="md:hidden px-4 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white rounded-lg text-xl">‚ò∞</button>
                  <div className={`${showMenu ? 'flex' : 'hidden'} md:flex flex-col md:flex-row gap-2 absolute md:relative top-20 md:top-0 right-6 md:right-0 bg-white dark:bg-gray-800 md:bg-transparent p-4 md:p-0 rounded-lg shadow-lg md:shadow-none z-50`}>
                    <button onClick={() => { setIsDark(!isDark); setShowMenu(false); }} className="px-4 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white rounded-lg text-sm whitespace-nowrap">
                      {isDark ? '‚òÄÔ∏è Light' : 'üåô Dark'}
                    </button>
                    {accessToken ? (
                      <>
                        <button onClick={() => { handleUploadToDrive(); setShowMenu(false); }} className="px-4 py-2 bg-green-100 hover:bg-green-200 dark:bg-green-900 dark:hover:bg-green-800 dark:text-white rounded-lg text-sm whitespace-nowrap">
                          ‚¨ÜÔ∏è Upload
                        </button>
                        <button onClick={() => { handleDownloadFromDrive(); setShowMenu(false); }} className="px-4 py-2 bg-blue-100 hover:bg-blue-200 dark:bg-blue-900 dark:hover:bg-blue-800 dark:text-white rounded-lg text-sm whitespace-nowrap">
                          ‚¨áÔ∏è Download
                        </button>
                        <button onClick={() => { handleGoogleSignOut(); setShowMenu(false); }} className="px-4 py-2 bg-red-100 hover:bg-red-200 dark:bg-red-900 dark:hover:bg-red-800 dark:text-white rounded-lg text-sm whitespace-nowrap">
                          üîì Sign Out
                        </button>
                      </>
                    ) : (
                      <button onClick={() => { handleGoogleSignIn(); setShowMenu(false); }} className="px-4 py-2 bg-green-100 hover:bg-green-200 dark:bg-green-900 dark:hover:bg-green-800 dark:text-white rounded-lg text-sm whitespace-nowrap">
                        üíæ Sign In
                      </button>
                    )}
                    <button onClick={() => { setView('weights'); setShowMenu(false); }} className="px-4 py-2 bg-purple-100 hover:bg-purple-200 dark:bg-purple-900 dark:hover:bg-purple-800 dark:text-white rounded-lg text-sm whitespace-nowrap">‚öñÔ∏è Weight</button>
                    <button onClick={() => { setView('history'); setShowMenu(false); }} className="px-4 py-2 bg-blue-100 hover:bg-blue-200 dark:bg-blue-900 dark:hover:bg-blue-800 dark:text-white rounded-lg text-sm whitespace-nowrap">üìÖ History</button>
                    <button onClick={() => { setView('setup'); setShowMenu(false); }} className="px-4 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white rounded-lg text-sm whitespace-nowrap">‚öôÔ∏è Settings</button>
                  </div>
                </div>
              </div>
              {st > 0 && <div className="bg-purple-50 dark:bg-purple-900/30 border border-purple-200 dark:border-purple-800 rounded-lg p-4 mb-4"><p className="text-purple-800 dark:text-purple-300 font-semibold">üî• {st} day streak!</p></div>}
              {ws && <div className="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6"><h3 className="font-semibold text-blue-900 dark:text-blue-300 mb-2 flex items-center gap-2"><TrendingUp />Last 7 Days</h3><div className="grid grid-cols-3 gap-4 text-sm"><div><p className="text-blue-700 dark:text-blue-400">Avg Net Cal</p><p className="text-lg font-bold text-blue-900 dark:text-blue-300">{ws.avg}</p></div><div><p className="text-blue-700 dark:text-blue-400">Avg Left</p><p className="text-lg font-bold text-blue-900 dark:text-blue-300">{ws.avgRem}</p></div><div><p className="text-blue-700 dark:text-blue-400">Success</p><p className="text-lg font-bold text-blue-900 dark:text-blue-300">{ws.ok}/{ws.tot}</p></div></div></div>}
              {b && b.msg ? <div className="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg p-6 text-center"><Clock /><p className="text-lg text-gray-700 dark:text-gray-300 mt-3">{b.msg}</p></div> : b && <><div className="mb-6"><div className="flex justify-between mb-2"><span className="text-sm font-medium dark:text-gray-300">Progress</span><span className="text-sm font-medium dark:text-gray-300">{b.cons} / {b.adjustedGoal} cal {b.exCal > 0 && <span className="text-green-600 dark:text-green-400">(+{b.exCal} exercise)</span>}</span></div><div className="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4"><div className={`h-full rounded-full ${prog <= 100 ? 'bg-green-500' : 'bg-red-500'}`} style={{width: `${prog}%`}} /></div></div><div className="grid grid-cols-3 gap-4 mb-6"><div className="bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 rounded-lg p-4"><p className="text-sm text-gray-600 dark:text-gray-400 mb-1">Budgeted</p><p className="text-3xl font-bold text-green-700 dark:text-green-400">{b.bud}</p><p className="text-xs text-gray-500 dark:text-gray-500 mt-1">{b.perHr}/hr</p></div><div className="bg-orange-50 dark:bg-orange-900/30 border border-orange-200 dark:border-orange-800 rounded-lg p-4"><p className="text-sm text-gray-600 dark:text-gray-400 mb-1">Net Cals</p><p className="text-3xl font-bold text-orange-700 dark:text-orange-400">{b.cons}</p>{b.exCal > 0 && <p className="text-xs text-gray-500 dark:text-gray-500 mt-1">{b.grossCons} - {b.exCal}</p>}</div><div className={`border rounded-lg p-4 ${b.rem >= 0 ? 'bg-blue-50 dark:bg-blue-900/30 border-blue-200 dark:border-blue-800' : 'bg-red-50 dark:bg-red-900/30 border-red-200 dark:border-red-800'}`}><p className="text-sm text-gray-600 dark:text-gray-400 mb-1">Remaining</p><p className={`text-3xl font-bold ${b.rem >= 0 ? 'text-blue-700 dark:text-blue-400' : 'text-red-700 dark:text-red-400'}`}>{b.rem}</p></div></div><div className="bg-amber-50 dark:bg-amber-900/30 rounded-lg p-4"><p className="text-sm text-gray-600 dark:text-gray-300"><span className="font-semibold">Goal:</span> {settings.goal} cal{b.exCal > 0 && <span className="text-green-600 dark:text-green-400"> (+{b.exCal} = {b.adjustedGoal})</span>}<span className="mx-2">|</span><span className="font-semibold">Hours:</span> {settings.start}:00-{settings.end}:00</p></div></>}
            </div>
            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-bold flex items-center gap-2 dark:text-white"><Utensils />Log Feed</h2>
                <button onClick={() => setShowCalc(true)} className="px-4 py-2 bg-blue-100 hover:bg-blue-200 dark:bg-blue-900 dark:hover:bg-blue-800 dark:text-white rounded-lg text-2xl">üßÆ</button>
              </div>
              <div className="mb-4"><p className="text-sm text-gray-600 dark:text-gray-400 mb-2">Quick Add:</p><div className="flex gap-2"><button onClick={() => quick(100)} className="px-4 py-2 bg-green-100 hover:bg-green-200 dark:bg-green-900 dark:hover:bg-green-800 rounded-lg text-green-800 dark:text-green-300 font-medium">+100</button><button onClick={() => quick(200)} className="px-4 py-2 bg-green-100 hover:bg-green-200 dark:bg-green-900 dark:hover:bg-green-800 rounded-lg text-green-800 dark:text-green-300 font-medium">+200</button><button onClick={() => quick(500)} className="px-4 py-2 bg-green-100 hover:bg-green-200 dark:bg-green-900 dark:hover:bg-green-800 rounded-lg text-green-800 dark:text-green-300 font-medium">+500</button></div></div>
              <div className="grid grid-cols-4 gap-3 mb-6"><div><label className="block text-sm font-medium mb-1 dark:text-gray-300">Hour</label><input type="number" min="0" max="23" value={newFeed.hour} onChange={(e) => setNewFeed({...newFeed, hour: e.target.value})} placeholder="now" className="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg" /></div><div><label className="block text-sm font-medium mb-1 dark:text-gray-300">Calories</label><input type="number" min="0" value={newFeed.cal} onChange={(e) => setNewFeed({...newFeed, cal: e.target.value})} placeholder="450" className="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg" /></div><div><label className="block text-sm font-medium mb-1 dark:text-gray-300">Note</label><input type="text" value={newFeed.note} onChange={(e) => setNewFeed({...newFeed, note: e.target.value})} placeholder="snack" className="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg" /></div><div className="flex items-end"><button onClick={add} className="w-full px-6 py-2 bg-orange-500 hover:bg-orange-600 text-white font-semibold rounded-lg">Add</button></div></div>
              <div className="space-y-2"><h3 className="text-lg font-semibold mb-3 dark:text-white">Today's Feeds</h3>{!feeds.length ? <p className="text-gray-500 dark:text-gray-400 text-center py-8">No feeds yet</p> : feeds.map((f, i) => <div key={i} className="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">{editIdx === i ? <div className="flex gap-2 items-center"><input type="number" min="0" max="23" value={editVals.hour} onChange={(e) => setEditVals({...editVals, hour: e.target.value})} className="w-20 px-2 py-1 border dark:border-gray-600 dark:bg-gray-600 dark:text-white rounded" /><input type="number" min="0" value={editVals.cal} onChange={(e) => setEditVals({...editVals, cal: e.target.value})} className="w-24 px-2 py-1 border dark:border-gray-600 dark:bg-gray-600 dark:text-white rounded" /><input type="text" value={editVals.note} onChange={(e) => setEditVals({...editVals, note: e.target.value})} className="flex-1 px-2 py-1 border dark:border-gray-600 dark:bg-gray-600 dark:text-white rounded" /><button onClick={() => saveEdit(i)} className="text-green-600 dark:text-green-400 font-medium">Save</button><button onClick={() => setEditIdx(null)} className="text-gray-600 dark:text-gray-400 font-medium">Cancel</button></div> : <div className="flex justify-between items-center"><div><span className="font-semibold dark:text-white">{f.hour}:00</span><span className="mx-2 text-gray-400">‚Ä¢</span><span className="dark:text-gray-200">{f.cal} cal</span>{f.note && <span className="ml-2 text-gray-500 dark:text-gray-400 text-sm">({f.note})</span>}</div><div className="flex gap-2"><button onClick={() => startEdit(i)} className="text-blue-600 dark:text-blue-400 text-sm font-medium">Edit</button><button onClick={() => del(i)} className="text-red-600 dark:text-red-400 text-sm font-medium">Delete</button></div></div>}</div>)}</div>
            </div>
            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8">
              <h2 className="text-2xl font-bold mb-4 flex items-center gap-2 dark:text-white"><span className="text-2xl">üí™</span>Log Exercise</h2>
              <div className="mb-4"><p className="text-sm text-gray-600 dark:text-gray-400 mb-2">Quick Add:</p><div className="flex gap-2"><button onClick={() => quickEx(100)} className="px-4 py-2 bg-blue-100 hover:bg-blue-200 dark:bg-blue-900 dark:hover:bg-blue-800 rounded-lg text-blue-800 dark:text-blue-300 font-medium">100</button><button onClick={() => quickEx(200)} className="px-4 py-2 bg-blue-100 hover:bg-blue-200 dark:bg-blue-900 dark:hover:bg-blue-800 rounded-lg text-blue-800 dark:text-blue-300 font-medium">200</button><button onClick={() => quickEx(300)} className="px-4 py-2 bg-blue-100 hover:bg-blue-200 dark:bg-blue-900 dark:hover:bg-blue-800 rounded-lg text-blue-800 dark:text-blue-300 font-medium">300</button></div></div>
              <div className="grid grid-cols-4 gap-3 mb-6"><div><label className="block text-sm font-medium mb-1 dark:text-gray-300">Hour</label><input type="number" min="0" max="23" value={newExercise.hour} onChange={(e) => setNewExercise({...newExercise, hour: e.target.value})} placeholder="now" className="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg" /></div><div><label className="block text-sm font-medium mb-1 dark:text-gray-300">Calories</label><input type="number" min="0" value={newExercise.cal} onChange={(e) => setNewExercise({...newExercise, cal: e.target.value})} placeholder="300" className="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg" /></div><div><label className="block text-sm font-medium mb-1 dark:text-gray-300">Activity</label><input type="text" value={newExercise.note} onChange={(e) => setNewExercise({...newExercise, note: e.target.value})} placeholder="run" className="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg" /></div><div className="flex items-end"><button onClick={addExercise} className="w-full px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg">Add</button></div></div>
              <div className="space-y-2"><h3 className="text-lg font-semibold mb-3 dark:text-white">Today's Exercise</h3>{!exercises.length ? <p className="text-gray-500 dark:text-gray-400 text-center py-8">No exercise logged yet</p> : exercises.map((ex, i) => <div key={i} className="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg">{editExIdx === i ? <div className="flex gap-2 items-center"><input type="number" min="0" max="23" value={editExVals.hour} onChange={(e) => setEditExVals({...editExVals, hour: e.target.value})} className="w-20 px-2 py-1 border dark:border-gray-600 dark:bg-gray-600 dark:text-white rounded" /><input type="number" min="0" value={editExVals.cal} onChange={(e) => setEditExVals({...editExVals, cal: e.target.value})} className="w-24 px-2 py-1 border dark:border-gray-600 dark:bg-gray-600 dark:text-white rounded" /><input type="text" value={editExVals.note} onChange={(e) => setEditExVals({...editExVals, note: e.target.value})} className="flex-1 px-2 py-1 border dark:border-gray-600 dark:bg-gray-600 dark:text-white rounded" /><button onClick={() => saveEditEx(i)} className="text-green-600 dark:text-green-400 font-medium">Save</button><button onClick={() => setEditExIdx(null)} className="text-gray-600 dark:text-gray-400 font-medium">Cancel</button></div> : <div className="flex justify-between items-center"><div><span className="font-semibold dark:text-white">{ex.hour}:00</span><span className="mx-2 text-gray-400">‚Ä¢</span><span className="text-green-600 dark:text-green-400 font-bold">+{ex.cal} cal</span>{ex.note && <span className="ml-2 text-gray-500 dark:text-gray-400 text-sm">({ex.note})</span>}</div><div className="flex gap-2"><button onClick={() => startEditEx(i)} className="text-blue-600 dark:text-blue-400 text-sm font-medium">Edit</button><button onClick={() => delEx(i)} className="text-red-600 dark:text-red-400 text-sm font-medium">Delete</button></div></div>}</div>)}</div>
            </div>
          </div>
        </div>
      );
    }  

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<PotatoTracker />);
  </script>
</body>
</html>
